<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>智能二维码图片生成器 (最终版)</title>
    <style>
        /* CSS样式与上一版基本相同 */
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; background-color: #f4f4f4; margin: 20px 0; padding: 0 20px; gap: 24px; flex-wrap: wrap; }
        .main-content { flex: 1; max-width: 800px; min-width: 420px; }
        .history-panel { width: 300px; flex-shrink: 0; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .input-group { margin-bottom: 15px; }
        .input-group textarea { width: calc(100% - 22px); padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        button { border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
        #output { margin-top: 20px; text-align: center; }
        canvas { border: 1px solid #ccc; max-width: 100%; height: auto; }
        .actions-group { display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
        .input-actions button { font-size: 12px; padding: 6px 10px; background-color: #6c757d; color: white; }
        .input-actions button:hover { background-color: #5a6268; }
        .main-actions-container { justify-content: flex-start; margin-top: 20px; }
        .main-actions-container button { padding: 10px 15px; font-size: 14px; color: white; }
        .main-actions-container .generate-btn { background-color: #007bff; }
        .main-actions-container .generate-btn:hover { background-color: #0056b3; }
        .main-actions-container .copy-btn { background-color: #28a745; }
        .main-actions-container .copy-btn:hover { background-color: #218838; }
        .main-actions-container .download-btn { background-color: #17a2b8; }
        .main-actions-container .download-btn:hover { background-color: #138496; }
        .main-actions-container .share-btn { background-color: #ffc107; color: black; }
        .main-actions-container .share-btn:hover { background-color: #e0a800; }
        #history-list { list-style-type: decimal; padding-left: 20px; margin: 0; max-height: 600px; overflow-y: auto; }
        #history-list li { padding: 8px; cursor: pointer; border-radius: 4px; word-break: break-all; }
        #history-list li:hover { background-color: #f0f0f0; }
        .history-panel h2 { margin-top: 0; }
        .history-panel .clear-history-btn { background-color: #dc3545; color: white; margin-top: 10px; padding: 8px 12px; }
        .history-panel .clear-history-btn:hover { background-color: #c82333;}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
</head>
<body>

    <!-- 主内容区域 -->
    <div class="main-content">
        <div class="container">
            <div class="input-group">
                <textarea id="qr-data" rows="3" oninput="parseVmessLink()" placeholder="1. 在此粘贴原始vmess链接..."></textarea>
                <div class="actions-group input-actions">
                    <button onclick="pasteFromClipboard()">一键粘贴</button>
                    <button onclick="clearVmessInput()">一键清除</button>
                </div>
            </div>
            <div class="input-group">
                <textarea id="top-text" rows="3" placeholder="2. 在此编辑图片顶部文字..."></textarea>
            </div>
            <div class="actions-group main-actions-container">
                <button class="generate-btn" onclick="generateImage()">生成图片</button>
                <button class="copy-btn" id="copy-button" onclick="copyImage()" style="display: none;">复制图片</button>
                <button class="download-btn" id="download-button" onclick="downloadImage()" style="display: none;">下载图片</button>
                <button class="share-btn" id="share-button" onclick="shareImage()" style="display: none;">分享图片</button>
            </div>
            <div id="output">
                <canvas id="canvas"></canvas>
            </div>
        </div>
    </div>

    <!-- 历史记录面板 -->
    <div class="history-panel container">
        <h2>历史记录</h2>
        <ol id="history-list"></ol>
        <button class="clear-history-btn" onclick="clearHistory()">清空所有历史记录</button>
    </div>

    <script>
        let parsedVmessData = null;
        const HISTORY_KEY = 'qrGeneratorHistory_v3'; // 更新版本号以避免与旧格式冲突

        // ... (此处省略了 pasteFromClipboard, clearVmessInput, copyImage, downloadImage, shareImage 等辅助函数，它们与上一版完全相同)
        async function pasteFromClipboard() { try { const text = await navigator.clipboard.readText(); document.getElementById('qr-data').value = text; parseVmessLink(); } catch (err) { alert('粘贴失败！请确保已授予浏览器读取剪贴板的权限。'); } }
        function clearVmessInput() { document.getElementById('qr-data').value = ''; document.getElementById('top-text').value = ''; parsedVmessData = null; }
        function copyImage() { const canvas = document.getElementById('canvas'); canvas.toBlob(function(blob) { try { navigator.clipboard.write([ new ClipboardItem({ 'image/png': blob }) ]); alert('图片已成功复制到剪贴板！'); } catch (error) { alert('复制失败！您的浏览器可能不支持此功能或未授予权限。'); } }, 'image/png'); }
        function downloadImage() { const canvas = document.getElementById('canvas'); const link = document.createElement('a'); link.download = '二维码.png'; link.href = canvas.toDataURL('image/png'); link.click(); }
        async function shareImage() { const canvas = document.getElementById('canvas'); const topText = document.getElementById('top-text').value.replace(/\n/g, ' ') || '二维码图片'; canvas.toBlob(async (blob) => { const file = new File([blob], '二维码.png', { type: 'image/png' }); const shareData = { title: '分享二维码', text: topText, files: [file] }; try { await navigator.share(shareData); } catch (error) { if (error.name !== 'AbortError') { alert('分享失败，发生未知错误。'); } } }, 'image/png'); }
        
        // --- 历史记录功能 (已重构) ---
        function saveToHistory(entry) {
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            // 简单检查，避免完全一样的条目重复添加
            if (history.length > 0 && JSON.stringify(history[0].data) === JSON.stringify(entry.data)) {
                return;
            }
            history.unshift(entry);
            if (history.length > 50) history = history.slice(0, 50); // 最多保存50条
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            const listElement = document.getElementById('history-list');
            listElement.innerHTML = '';
            history.forEach((entry, index) => {
                const li = document.createElement('li');
                // 显示标题，优先使用顶部文字，如果没有则用vmess链接代替
                const title = entry.data.topText.replace(/\n/g, ' ') || entry.data.vmess || '[无标题]';
                li.textContent = title;
                li.title = `点击恢复: ${title}`;
                li.onclick = () => loadFromHistory(index);
                listElement.appendChild(li);
            });
        }

        function loadFromHistory(index) {
            const history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            if (history[index]) {
                const entry = history[index];
                // 恢复文字内容
                document.getElementById('qr-data').value = entry.data.vmess;
                document.getElementById('top-text').value = entry.data.topText;
                // 解析vmess链接以准备
                parseVmessLink();
                // 使用快照中的设置，直接调用生成函数
                generateImage(entry.settings);
            }
        }
        function clearHistory() {
            if (confirm('确定要清空所有历史记录吗？此操作无法撤销。')) {
                localStorage.removeItem(HISTORY_KEY);
                renderHistory();
            }
        }
        
        // --- 核心功能 ---
        function parseVmessLink() {
            const qrDataInput = document.getElementById('qr-data');
            const topTextInput = document.getElementById('top-text');
            const link = qrDataInput.value;
            if (link.trim().startsWith('vmess://')) {
                try {
                    const base64String = link.substring(8);
                    const decodedString = atob(base64String);
                    parsedVmessData = JSON.parse(decodedString);
                    if (parsedVmessData.hasOwnProperty('ps')) {
                        topTextInput.value = parsedVmessData.ps;
                    } else {
                        parsedVmessData.ps = ""; topTextInput.value = "";
                    }
                } catch (e) { parsedVmessData = null; }
            } else { parsedVmessData = null; }
        }
        
        function generateImage(settingsOverride) {
            // ====================================================================================================
            // ===                                【最终样式与布局控制中心】                                    ===
            // ====================================================================================================
            const settings = settingsOverride || {
                // 如果没有从历史记录加载，则使用这里的默认设置
                canvasWidth: 400, canvasHeight: 550, qrBoxSize: 400,
                topTextSize: 32, topTextColor: '#FF0000',
                dateTimeTextSize: 18, dateTimeTextColor: '#FF0000',
                canvasBackgroundColor: '#FFFFFF',
                contentVerticalOffset: 10, topTextVerticalOffset: 17, dateTimeVerticalOffset: -25
            };
            // ====================================================================================================
            
            const originalLink = document.getElementById('qr-data').value;
            const topTextFromUser = document.getElementById('top-text').value;
            
            let finalQrData;
            if (parsedVmessData) {
                const newPs = topTextFromUser.replace(/\n/g, ' '); parsedVmessData.ps = newPs;
                const newJsonString = JSON.stringify(parsedVmessData);
                try {
                    const newBase64String = btoa(unescape(encodeURIComponent(newJsonString)));
                    finalQrData = 'vmess://' + newBase64String;
                } catch (e) { alert('生成二维码失败：文本中可能包含无法编码的特殊字符。'); return; }
            } else { finalQrData = originalLink || topTextFromUser; }

            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = settings.canvasWidth;
            canvas.height = settings.canvasHeight;

            const topLines = topTextFromUser.split('\n');
            const topTextLineHeight = parseInt(settings.topTextSize, 10) * 1.2;
            const topTextBlockHeight = (topTextFromUser ? topLines.length : 0) * topTextLineHeight;
            const dateTimeLineHeight = parseInt(settings.dateTimeTextSize, 10) * 1.2;
            const dateTimeBlockHeight = dateTimeLineHeight;
            const spacingBetweenElements = 20;

            let totalContentHeight = settings.qrBoxSize;
            if (topTextFromUser) { totalContentHeight += spacingBetweenElements + topTextBlockHeight; }
            totalContentHeight += spacingBetweenElements + dateTimeBlockHeight;
            let contentGroupStartY = (settings.canvasHeight - totalContentHeight) / 2 + settings.contentVerticalOffset;

            ctx.fillStyle = settings.canvasBackgroundColor; ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (topTextFromUser) {
                let currentY = contentGroupStartY + settings.topTextVerticalOffset;
                ctx.fillStyle = settings.topTextColor; ctx.font = `bold ${settings.topTextSize}px 思源黑体, sans-serif`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                const textStartX = canvas.width / 2;
                topLines.forEach((line, index) => {
                    const yPos = currentY + (topTextLineHeight / 2) + (index * topTextLineHeight);
                    ctx.fillText(line.trim(), textStartX, yPos);
                });
            }
            
            const qrStartY = contentGroupStartY + (topTextFromUser ? topTextBlockHeight + spacingBetweenElements : 0);
            try {
                const qr = qrcode(0, 'M'); qr.addData(finalQrData); qr.make();
                const qrCanvas = document.createElement('canvas'); qrCanvas.width = qrCanvas.height = settings.qrBoxSize;
                const qrCtx = qrCanvas.getContext('2d');
                qrCtx.fillStyle = '#ffffff'; qrCtx.fillRect(0, 0, settings.qrBoxSize, settings.qrBoxSize);
                const moduleCount = qr.getModuleCount(); const marginModules = 3; const totalModules = moduleCount + marginModules * 2; const moduleSize = settings.qrBoxSize / totalModules;
                for (let row = 0; row < moduleCount; row++) {
                    for (let col = 0; col < moduleCount; col++) {
                        if (qr.isDark(row, col)) {
                            qrCtx.fillStyle = '#000000';
                            const x = (col + marginModules) * moduleSize; const y = (row + marginModules) * moduleSize;
                            qrCtx.fillRect(x, y, moduleSize + 0.5, moduleSize + 0.5);
                        }
                    }
                }
                ctx.drawImage(qrCanvas, (canvas.width - settings.qrBoxSize) / 2, qrStartY, settings.qrBoxSize, settings.qrBoxSize);
                
                document.getElementById('copy-button').style.display = 'inline-block';
                document.getElementById('download-button').style.display = 'inline-block';
                initializeShareButton(); 
                
                // 只有在不是从历史记录恢复时才创建新的历史条目
                if (!settingsOverride) {
                    const historyEntry = {
                        data: {
                            vmess: originalLink,
                            topText: topTextFromUser
                        },
                        settings: settings
                    };
                    saveToHistory(historyEntry);
                }

            } catch (e) { alert("生成失败！\n\n原因：您输入的文字太长，导致最终链接超出了二维码的最大容量。\n\n解决方法：请尝试缩短【图片顶部文字】的内容。"); }
            
            const now = new Date(); const pad = (num) => num.toString().padStart(2, '0');
            const dateTimeString = `${now.getFullYear()}年${pad(now.getMonth() + 1)}月${pad(now.getDate())}日 ${pad(now.getHours())}点${pad(now.getMinutes())}分${pad(now.getSeconds())}秒`;
            ctx.font = `bold ${settings.dateTimeTextSize}px 思源黑体, sans-serif`; 
            ctx.fillStyle = settings.dateTimeTextColor; 
            const dateTimeYPos = qrStartY + settings.qrBoxSize + spacingBetweenElements + (dateTimeBlockHeight / 2) + settings.dateTimeVerticalOffset;
            ctx.fillText(dateTimeString, canvas.width / 2, dateTimeYPos);
        }
        
        function initializeShareButton() {
            const shareButton = document.getElementById('share-button');
            if (navigator.share && navigator.canShare) {
                const dummyFile = new File(["dummy"], "dummy.png", {type: "image/png"});
                if (navigator.canShare({ files: [dummyFile] })) {
                    shareButton.style.display = 'inline-block';
                } else { shareButton.style.display = 'none'; }
            } else { shareButton.style.display = 'none'; }
        }
        
        window.onload = function() {
            renderHistory();
            initializeShareButton();
        };

    </script>
</body>
</html>